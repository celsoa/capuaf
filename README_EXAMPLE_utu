README_EXAMPLE_utu

See README_EXAMPLE first -- run the default example.

====================================================================================
COMMANDS AND FIGURES TO RECREATE INVERSION RESULTS IN PAPER
            Uturuncu event 20100516063454464 
            Velocity model utu1D

Part 1. 

1. Find best depth by running inversions for each depth

> for depth in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ; do cap.pl -W1 -E1 -K1 -Y1 -I5/0.1/5 -J-90/90/-30/30 -D1/1/0.5 -H0.01 -C2/10/0.25/0.5 -S0.1/2.0/0 -T1.5/60 -L0.10 -F0 -Mutu1D_$depth/2.8 -Zw_utu1D_P01_V01_R01_S01.dat 20100516063454464 ; done

2. compile summary figure
> depth_test 20100516063454464 utu1D

3. compare results
> gv 20100516063454464_check/depth_test_20100516063454464_utu1D.ps
> gv dep_20100516063454464.ps

Part 2. check if cap is set correctly, verify inversion parameters

1. go to run directory

> cd $CAPHOME/EXAMPLES

2. check values in the weight.dat file

> more 20100516063454464/w_utu1D_P01_V01_R01_S01.dat

note:
    1. file name reflects weights for each station in the file, eg: 1-1-1-1-1
    2. all P arrivals times were obtained from analyst picks
    3. surface wave time shifts are set to 0.0 for utu1D

3a. Make sure cap is set to its original condition

> cd $CAPHOME
> svn revert cap.c 

3b. Make sure cap is compiled with the following flags then compile

    FTC_data=1
    FTC_green=0
    skip_zero_weights=0

> make cap

Part 3. run cap inversions WITH and WITHOUT: polarities, body waves, surface waves

1a. Run with polarities, full grid search, components 1-1-1 and plot with absolute amplitudes.

> cd $CAPHOME/EXAMPLES
> cap.pl -H0.01 -P1e-5/1/30 -p0.1 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -E1 -K1 -Y1 -I5/0.1/5 -J-90/90/-30/30 -Mutu1D_4/2.9 -Zw_utu1D_P01_V01_R01_S01.dat 20100516063454464

1b. compare results and verify .out file:

> gv 20100516063454464/utu1D_004_fmt.ps &
> gv 20100516063454464_check/utu1D_004_fmt_P01_V01_R01_S01_scale_abs.ps &
> diff 20100516063454464/utu1D_004.out 20100516063454464_check/utu1D_004_fmt_P01_V01_R01_S01.out

2a. Run WITHOUT polarities, full grid search, components 1-1-1
> cap.pl -H0.01 -P1e-5/1/30 -p0.1 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -E1 -K1 -Y1 -I5/0.1/5 -J-90/90/-30/30 -Mutu1D_4/2.9 -Zw_utu1D_P00_V01_R01_S01.dat 20100516063454464 

2b. Compare results
gv 20100516063454464/utu1D_004_fmt.ps &
gv 20100516063454464_check/utu1D_004_fmt_P00_V01_R01_S01.ps

3a. Run with polarities, full grid search, components 1-1-0
> cap.pl -H0.01 -P1e-5/1/30 -p0.1 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -E1 -K1 -Y1 -I5/0.1/5 -J-90/90/-30/30 -Mutu1D_4/2.9 -Zw_utu1D_P01_V01_R01_S00.dat 20100516063454464 

3b. Compare results
gv 20100516063454464/utu1D_004_fmt.ps &
gv 20100516063454464_check/utu1D_004_fmt_P01_V01_R01_S00.ps

4a. Run WITHOUT polarities, full grid search, components 1-1-0
> cap.pl -H0.01 -P1e-5/1/30 -p0.1 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -E1 -K1 -Y1 -I5/0.1/5 -J-90/90/-30/30 -Mutu1D_4/2.9 -Zw_utu1D_P00_V01_R01_S00.dat 20100516063454464 

4b. Compare results
gv 20100516063454464/utu1D_004_fmt.ps &
gv 20100516063454464_check/utu1D_004_fmt_P00_V01_R01_S00.ps


====================================================================================
EXAMPLE 12: Uturuncu event 20100516-063454464, first motion polarity

0. set cap.c to its original condition
> cd $CAPHOME
> svn revert cap.c 

1. In cap.c change: only_first_motion=1

2. Compile cap
> make all

3. To run cap
> cd $CAPHOME/EXAMPLES
> ./cap.pl -F0.0 -I5/0/5 -J-90/90/-30/30 -Mutuhalf_5/2.4 -E1 -K1 -Y1 -Zweight.dat 20100516063454464

4. This run should have produced file out.misfit.fmp_
   Next compute summary of first motion polarities using this file
> python $CAPHOME/misfit2lune.py out.misfit.fmp_ > out.misfit_summary

5. Plot polarity misfit on the lune with file out.misfit_summary

NOTES
1. Output file from cap run (step 3) will be file: out.misfit.fmp_
   This file is 708M for grid spacing of 5 degrees and can be deleted after computing summary
2. No figure should be created when running first motion polarity (i.e. run cap without -P flag)

====================================================================================
EXAMPLE 13: Uturuncu event 20100516-063454464
            Compare CAP solutions using different components 
            FMT with lune parameterization
            Full grid search (no line search)

[NOTE THAT THE GREEN'S FUNCTIONS ARE PRE-COMPUTED, SO THIS IS NOT NEEDED.]
PART 13.1 generate greens functions

1. run the frequency-wavenumber code fk

> mkdir -p $CAPRUN/models/utuhalf
> cd $CAPRUN/models/utuhalf/
> cp $CAPHOME/EXAMPLES/20100516063454464/utuhalf .
> fk.pl -Mutuhalf/5 -N16384/0.01 11 14 18 19 21 22 31 33 37 50

note: this uses the "utuhalf" 1D model for the Uturuncu region 
note: You do not need to run fk if you have a pre-computed library of Green's functions.

2. run fk again to generate isotropic components

> fk.pl -Mutuhalf/5 -N16384/0.01 -S0 11 14 18 19 21 22 31 33 37 50

This will create 3 additional green functions for each distance of the form dist.grn.(a-c),
eg. 11.grn.a, 11.grn.b, 11.grn.c

------------
PART 13.2. run cap inversion with polarities + Pnl + Surface data

note:
    ISO will be gridded by considering equal spacing in sin(iso) space
    DIP will be gridded by considering equal spacing in cos(dip) space

1. go to run directory

> cd $CAPHOME/EXAMPLES

2. check values in the weight.dat file

> more 20100516063454464/weight.dat

note:
    1. all weights should be set as 10 1 10 10 10, which gives higher weights to
       PV component and surface waves
    2. all P arrivals times were obtained from analyst picks

3a. Make sure cap is set to its original condition

> cd $CAPHOME
> svn revert cap.c 

3b. Make sure cap is compiled with the following flags then compile

    FTC_data=1
    FTC_green=0
    skip_zero_weights=0

> make cap

4a. Run cap and plot with absolute amplitudes

> cd $CAPHOME/EXAMPLES
> cap.pl -H0.01 -P1.5e-5/1/30 -p0.1 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -I5/0.1/5 -J-90/90/-30/30 -E1 -K1 -Y1 -Mutuhalf_5/2.4 -Zweight_V10_R01_S10.dat 20100516063454464

4b. compare results

> gv 20100516063454464/utuhalf_005_fmt.ps &
> gv $CAPHOME/EXAMPLES/20100516063454464_check/utuhalf_005_fmt_V10_R01_S10_scale_abs.ps &

5a. Run cap and plot with data and syn amplitudes normalized to the same scale.
    In cap_plt.plt (revision r2318) insert the following line after line #108 

> $stams = $stamb;

5b. run cap

> cap.pl -H0.01 -P0.5e+0.5/1/30 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -I5/0.1/5 -J-90/90/-30/30 -E1 -K1 -Y1 -Mutuhalf_5/2.4 -Zweight_V10_R01_S10.dat 20100516063454464 

5c. compare results and verify .out file:

> gv 20100516063454464/utuhalf_005_fmt.ps &
> gv $CAPHOME/EXAMPLES/20100516063454464_check/utuhalf_005_fmt_V10_R01_S10.ps &
> diff 20100516063454464/utuhalf_005.out $CAPHOME/EXAMPLES/20100516063454464_check/utuhalf_005.out

Note:
    1. plotting flag is set to -P0.5e+0.5/... which is a kludge for unnormalized plotting
    2. lune grid will NOT do a refined search, so pick -I accordingly (here: 5 deg inc on lune; 0.1 inc Mw)
    3. because all P arrivals are hand-picked (to within 0.01 s), we set the allowable time shift for P to 0.1 s
    4. -L gives the half-duration of the synthetics; this is a key command to get high-frequency synthetics in P (but not too high)
    5. the result is an improvement of the BSSA2014 poster (same event)
    6. surface wave time shifts are allowed to be between 0.0 s and 4.0 s, which reflects our belief that either:
       (a) the model is systematically too slow
       (b) the depth is wrong
       (c) the origin time is wrong
    7. We are able to specify the 0.0 to 4.0 s (*) shifts with two changes:
       (1) the relative surface time shifts are +/- 2.0, which is set as -S0.2/2.0/0
       (2) the systematic S_shifts in weight file (last column) are set to 2.0 
       (*) actual time shifts are then 0.0 s (-2.0 + 2.0) and 4.0 s (+2.0 + 2.0)

6a. try the same run but with different weights:

NOTE
    1. Weights are set as 1 1 60 60 60, which gives all weight to surface waves

    2. This cap run is centered around M2.9 for peace of mind. See also Ex. 10.
    M2.9 is the best magnitude for this solution, and also happens to be 
    the top limit in grid search (catalog mag = 2.4 +/- 0.5).

> cap.pl -H0.01 -P0.5e+0.5/1/30 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -I5/0.1/5 -J-90/90/-30/30 -E1 -K1 -Y1 -Mutuhalf_5/2.4 -Zweight_V01_R01_S60.dat 20100516063454464

6b. compare results

> gv 20100516063454464/utuhalf_005_fmt.ps &
> gv $CAPHOME/EXAMPLES/20100516063454464_check/utuhalf_005_fmt_V01_R01_S60.ps &

7a. try polarities + component PV

> cap.pl -H0.01 -P0.5e+0.5/1/30 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -I5/0.1/5 -J-90/90/-30/30 -E1 -K1 -Y1 -Mutuhalf_5/2.4 -Zweight_V10_R00_S00.dat 20100516063454464

7b. compare results

> gv 20100516063454464/utuhalf_005_fmt.ps 
> gv $CAPHOME/EXAMPLES/20100516063454464_check/utuhalf_005_fmt_V10_R00_S00.ps &

8a. try polarities + component PR

> cap.pl -H0.01 -P2e-06/1/30 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -I5/0.1/5 -J-90/90/-30/30 -E1 -K1 -Y1 -Mutuhalf_5/2.4 -Zweight_V00_R01_S00.dat 20100516063454464

8b. compare results

gv 20100516063454464/utuhalf_005_fmt.ps 
gv $CAPHOME/EXAMPLES/20100516063454464_check/utuhalf_005_fmt_V00_R01_S00.ps &

9a. try polarities + components PV + PR

> cap.pl -H0.01 -P0.5e+0.5/1/30 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -I5/0.1/5 -J-90/90/-30/30 -E1 -K1 -Y1 -Mutuhalf_5/2.4 -Zweight_V10_R01_S00.dat 20100516063454464

9b. compare results

> gv 20100516063454464/utuhalf_005_fmt.ps &
> gv $CAPHOME/EXAMPLES/20100516063454464_check/utuhalf_005_fmt_V10_R01_S00.ps &

10a. try polarities + components S (Surface waves)

NOTE
    This cap run is centered around M2.9 for peace of mind. See also Ex. 6.
    M2.9 is the best magnitude for this solution, and also happens to be 
    the top limit in grid search (catalog mag = 2.4 +/- 0.5).

> cap.pl -H0.01 -P0.5e+0.5/1/30 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -I5/0.1/5 -J-90/90/-30/30 -E1 -K1 -Y1 -Mutuhalf_5/2.4 -Zweight_V00_R00_S10.dat 20100516063454464

10b. compare results

> gv 20100516063454464/utuhalf_005_fmt.ps &
> gv $CAPHOME/EXAMPLES/20100516063454464_check/utuhalf_005_fmt_V00_R00_S10.ps &

11a. try NO polarities + components PV + PR + S

note: by not using polarities (to exclude large portions of misfit space), the search can take 2+ hours

> cap.pl -H0.01 -P0.5e+0.5/1/30 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -I5/0.1/5 -J-90/90/-30/30 -E1 -K1 -Y1 -Mutuhalf_5/2.4 -Zweight_V10_R01_S10_nopol.dat 20100516063454464

11b. compare results

> gv 20100516063454464/utuhalf_005_fmt.ps &
> gv $CAPHOME/EXAMPLES/20100516063454464_check/utuhalf_005_fmt_V10_R01_S10_nopol.ps &

12a. try polarities + components PV + PR + S BUT constrained to DC

> cap.pl -H0.01 -P0.5e+0.5/1/30 -S0.1/2.0/0 -T1.5/60 -D1/1/0.5 -C2/10/0.25/0.5 -F0.0 -L0.1 -W1 -I5/0.1 -J0/0/0/0 -E1 -K1 -Y1 -Mutuhalf_5/2.4 -Zweight_V10_R01_S10.dat 20100516063454464 

12b. compare results

> gv 20100516063454464/utuhalf_005_fmt.ps &
> gv $CAPHOME/EXAMPLES/20100516063454464_check/utuhalf_005_DC_V10_R01_S10.ps &

note: this MUST be a worse solution than the non-DC version, since this solution was considered in the non-DC search

------------
PART 13.3. Depth test

1. Do inversions at each depth
> for depth in 1 2 3 4 5 6 7 8 9 10; do cap.pl -W1 -Y1 -D1/1/0.5 -H0.01 -C2/10/0.25/0.5 -F0 -L0.1 -S0.1/2.0/0 -P0.5e+0.5/1/30 -T1.5/60 -E1 -K1 -I5/0.1/5 -J-90/90/-30/30 -Mutuhalf_$depth/2.8 -Zweight_V10_R01_S10.dat 20100516063454464 ; done

2. Plot the result
> depth_test 20100516063454464 utuhalf

3. Compare results
> gv depth_test_20100516063454464.ps &
> gv $CAPHOME/EXAMPLES/20100516063454464_check/depth_test_20100516063454464.ps &

====================================================================================
EXAMPLE 14. Uturuncu event 20110622-023324299
            This example shows filter improvement for small signals when using
            flag filter-then-cut during cap run.
            1. FTC_data=0 (original) first cuts sections, then filters each section (cut-then-filter)
            2. FTC_data=1 first filters the entire seismogram, then cuts sections (filter-then-cut)

0. prepare run

> mkdir -p $CAPRUN/inv/utuhalf
> cd $CAPRUN/inv/utuhalf/
> rsync -av $CAPHOME/EXAMPLES/20110622023324299 .

1a. Start from default cap

> cd $CAPHOME
> svn revert cap.c

1b. cut-then-filter data. In cap.c set the flags below, compile then run

    FTC_data=0
    FTC_green=0
    skip_zero_weights=0

> make cap
> cd $CAPHOME/EXAMPLES
> cap.pl -H0.01 -P2e-5/1/30 -S0.1/2.0/0 -T1.5/60.0 -D1/1/0.5 -C1/10/0.1/0.4 -W1 -Y1 -F0 -L0.05 -E1 -K1 -I5/0/5 -J33.748/33.748/40/40 -R215/215/69.41/69.41/40/40 -Mutuhalf_9/0.6 -Zweight.dat 20110622023324299 

2. compare results

> gv 20110622023324299/utuhalf_009_fmt.ps &
> gv $CAPHOME/EXAMPLES/20110622023324299_check/utuhalf_009_fmt_cut-filter.ps &

3. filter-then-cut data. In cap.c set the flags below, compile then run

    FTC_data=1
    FTC_green=0

> make cap
> cd $CAPHOME/EXAMPLES
> cap.pl -H0.01 -P2e-5/1/30 -S0.1/2.0/0 -T1.5/60.0 -D1/1/0.5 -C1/10/0.1/0.4 -W1 -Y1 -F0 -L0.05 -E1 -K1 -I5/0/5 -J33.748/33.748/40/40 -R215/215/69.41/69.41/40/40 -Mutuhalf_9/0.6 -Zweight.dat 20110622023324299 

4. compare results

> gv 20110622023324299/utuhalf_009_fmt.ps &
> gv $CAPHOME/EXAMPLES/20110622023324299_check/utuhalf_009_fmt_filter-cut-data.ps &

5. Filter-then-cut data and greens functions. In cap.c set the flags below, compile then run 

    FTC_data=1
    FTC_green=1

> make cap
> cd $CAPHOME/EXAMPLES
> cap.pl -H0.01 -P0.5e+0.5/1/30 -S0.1/2.0/0 -T1.5/60.0 -D1/1/0.5 -C1/10/0.1/0.4 -W1 -Y1 -F0 -L0.05 -E1 -K1 -I5/0/5 -J33.748/33.748/40/40 -R215/215/69.41/69.41/40/40 -Mutuhalf_9/0.6 -Zweight.dat 20110622023324299 

Note: plotting flag is set to -P0.5e+0.5/... since greens functions in this mode appear too small

6. compare results

> gv 20110622023324299/utuhalf_009_fmt.ps &
> gv $CAPHOME/EXAMPLES/20110622023324299_check/utuhalf_009_fmt_filter-cut-data-greens.ps &

====================================================================================
