README_EXAMPLE

Test examples for CAP.
The default example should always be run, prior to committing any changes to the code.

Figures to check are in the directory 20080418093700_check_orig

============================================
START-UP INSTRUCTIONS

0. By default, do not run cap on a cluster (skip this step).

BUT: if on UAF cluster, check modules (GMT, netcdf, gfortran)

> module purge
> module load PrgEnv-gnu/4.5.1 gmt/4.5.7
> module list

load environment variables

> source $EUTIL/seismo_bashrc

1. check paths (see .bashrc)

> echo "CAPHOME =" $CAPHOME ;  echo "CAPRUN =" $CAPRUN ; echo "NRHOME_C =" $NRHOME_C ; echo "GMTHOME =" $GMTHOME

Make sure that none of these is empty.

note: by default at UAF you can set this in your .bashrc:

export GEOTOOLS=$HOME/GEOTOOLS
export SUTIL=/usr/local/seismo
export NRHOME_C=$SUTIL/grp-utils/nr/NR_C302/legacy/nr2/C_211_mod
export NRHOME_F90=$SUTIL/grp-utils/nr/recipes_f-90
export CAPHOME=$GEOTOOLS/tomo_util/cap
export PATH=$CAPHOME:$PATH
export CAPRUN=$HOME/PROJECTS/CAP
export PATH=$PATH:$SUTIL/bin:$HOME/bin:.

source the file after making changes

> source ~/.bashrc

2. set up directories within $CAPRUN

> echo $CAPRUN
> mkdir -p $CAPRUN
> cd $CAPRUN
> mkdir -p models inv ; mkdir -p models/cus inv/cus

3. compile cap.c

> cd $CAPHOME
> make all >& make.log

4. check path to utilities

> which fk pssac2 cap cap.pl cap_plt.pl depth.pl depth_test

Make sure that none of these is missing.

============================================
DEFAULT EXAMPLE 1: ILLINOIS EVENT, DOUBLE COUPLE

1. run the frequency-wavenumber code fk

> cd $CAPRUN/models/cus
> cp $SUTIL/grp-utils/fk3.0/cus .
> fk.pl -Mcus/15 -N512/0.4/2 140 145 205 230 260 275 295

note: this uses the "cus" 1D model for "central U.S."
note: You do not need to run fk if you have a pre-computed library of Green's functions.

2. run fk again to generate isotropic components

> fk.pl -Mcus/15 -N512/0.4/2 -S0 140 145 205 230 260 275 295

 This will create 3 additional green functions for each distance of the form dist.grn.(a-c),
 e.g., 140.grn.a, 140.grn.b, 140.grn.c.

3. prepare data directory

> cd $CAPRUN/inv/cus
> rsync -av $CAPHOME/20080418093700 .

Check that you have new weight.dat file with 12 columns (3 extra for Pnl_window, surf_pick, surf_window).
The old weight file is under the name weight_orig.dat

> more 20080418093700/weight.dat

4. run cap

> cap.pl -H0.2 -P2.2e-6 -S2/5/0 -T35/70 -F -D2/1/0.5 -C0.05/0.3/0.02/0.1 -W1 -X10 -Mcus_15/5.0 20080418093700

> gv 20080418093700/cus_015.ps &

You should see a reasonable output for a moment tensor inversion.

5. check the output files

> gv $CAPHOME/20080418093700_check/cus_015.ps &
> diff 20080418093700/cus_015.out $CAPHOME/20080418093700_check/cus_015.out

(The output from the last command should be blank.)

6. perform the depth test

This requires computing Green's functions for the depths used in the grid search.

> cd $CAPRUN/models/cus
> fk.pl -Mcus/5  -N512/0.4/2 140 145 205 230 260 275 295 ; fk.pl -Mcus/5  -N512/0.4/2 -S0 140 145 205 230 260 275 295
> fk.pl -Mcus/10 -N512/0.4/2 140 145 205 230 260 275 295 ; fk.pl -Mcus/10 -N512/0.4/2 -S0 140 145 205 230 260 275 295
> fk.pl -Mcus/20 -N512/0.4/2 140 145 205 230 260 275 295 ; fk.pl -Mcus/20 -N512/0.4/2 -S0 140 145 205 230 260 275 295
> fk.pl -Mcus/25 -N512/0.4/2 140 145 205 230 260 275 295 ; fk.pl -Mcus/25 -N512/0.4/2 -S0 140 145 205 230 260 275 295
> fk.pl -Mcus/30 -N512/0.4/2 140 145 205 230 260 275 295 ; fk.pl -Mcus/30 -N512/0.4/2 -S0 140 145 205 230 260 275 295

Run cap for different depths by setting the range and increment for which you want to run depth test using -A flag (-Adep_min/dep_max/dep_inc). One output (.out) file should be generated for each depth.

> cd $CAPRUN/inv/cus
> cap.pl -H0.2 -P2.2e-6 -S2/5/0 -T35/70 -F -D2/1/0.5 -C0.05/0.3/0.02/0.1 -W1 -X10 -Mcus_15/5.0 -A5/30/5 20080418093700

Run depth_test (script for calling depth.pl)
> depth_test 20080418093700 cus 
> gv dep_20080418093700.ps &

5. check the depth test

> diff junk1.out $CAPHOME/20080418093700_check/junk1_dc.out
> diff junk2.out $CAPHOME/20080418093700_check/junk2_dc.out
> gv $CAPHOME/20080418093700_check/depth_dc.ps &

============================================
EXAMPLE 2: ILLINOIS EVENT, FMT with Zhu line search

1. Follow same step 1 EXAMPLE 1
2. Follow same step 2 EXAMPLE 1
3. Follow same step 3 EXAMPLE 1

4. run cap with the -J flag
ISO and CLVD will be searched for in their general range (-1<ISO<+1 ; -0.5<CLVD<0.25).
However you can change the increament by using -J flag in the input command line.

> cd $CAPRUN/inv/cus
> cap.pl -H0.2 -P2.2e-6 -S2/5/0 -T35/70 -F -D2/1/0.5 -C0.05/0.3/0.02/0.1 -W1 -X10 -Mcus_15/5.0 -J0/0.1/0/0.1 20080418093700
> gv 20080418093700/cus_015_fmt.ps &

5. check the output files

> gv $CAPHOME/20080418093700_check/cus_015_fmt_line.ps &
> diff 20080418093700/cus_015.out $CAPHOME/20080418093700_check/cus_015_fmt_line.out

(The output from the last command should be blank.)

6. perform the depth test (Green's functions already computed)

Run cap for different depths by setting the range and increment for which you want to run depth test using -A flag (-Adep_min/dep_max/dep_inc). One output (.out) file should be generated for each depth.

> cap.pl -H0.2 -P2.2e-6 -S2/5/0 -T35/70 -F -D2/1/0.5 -C0.05/0.3/0.02/0.1 -W1 -X10 -Mcus_15/5.0 -J0/0.1/0/0.1 -A5/30/5 20080418093700

note: -J0/0.1/0/0.1 means line search from (0,0) in increments of 0.1 in each direction

Run depth_test (script for calling depth.pl)
> depth_test 20080418093700 cus 
> gv dep_20080418093700.ps &

5. check the depth test

> diff junk1.out $CAPHOME/20080418093700_check/junk1_fmt_line.out
> diff junk2.out $CAPHOME/20080418093700_check/junk2_fmt_line.out
> gv $CAPHOME/20080418093700_check/depth_fmt_line.ps &

====================================================================================
EXAMPLE 3: ILLINOIS EVENT, DC, full grid search

This is like EXAMPLE 1, but here we use a single, uniform grid search with no line searches or refined grid searches.
This is aimed at performing a secondary analysis of uncertainties outside of CAP.

1. Follow same step 1 EXAMPLE 1
2. Follow same step 2 EXAMPLE 1
3. Follow same step 3 EXAMPLE 1

4. modify cap.c for full grid search

> cd $CAPHOME

open cap.c, set full_mt_search=1 (and preferably debug=0 so that it do not generate numerous output files), then save, then compile:

> make all

5.  run cap

> cd $CAPRUN/inv/cus
> cap.pl -H0.2 -P2.2e-6 -S2/5/0 -T35/70 -F -D2/1/0.5 -C0.05/0.3/0.02/0.1 -W1 -X10 -Mcus_15/5.0 -I10/.1 -J0/0/0/0 20080418093700
> gv 20080418093700/cus_015_fmt.ps &

note: -J0/0/0/0 means fixed ISO and CLVD components
note: -I here will use a coarser sampling of Mw (0.2 instead of 0.1)

6. check the output files

> gv $CAPHOME/20080418093700_check/cus_015_dc_grid.ps &
> diff 20080418093700/cus_015.out $CAPHOME/20080418093700_check/cus_015_dc_grid.out

====================================================================================
EXAMPLE 4: ILLINOIS EVENT, FMT with lune parameterization, full grid search

1. Follow same step 1 EXAMPLE 3
2. Follow same step 2 EXAMPLE 3
3. Follow same step 3 EXAMPLE 3
4. Follow same step 4 EXAMPLE 3

5.  run cap (this will take a couple minutes)
ISO and CLVD will be searched for in their general range (-90<ISO<+90 ; -30<CLVD<+30) (lune parameters).
However you can change the increament by using -J flag in the input command line.

> cd $CAPRUN/inv/cus
> cap.pl -H0.2 -P2.2e-6 -S2/5/0 -T35/70 -F -D2/1/0.5 -C0.05/0.3/0.02/0.1 -W1 -X10 -Mcus_15/5.0 -I10/.2 -J0/5/0/5 20080418093700
> gv 20080418093700/cus_015_fmt.ps &

note: -J0/5/0/5 means 5 deg increment in ISO (delta) and 5 deg increment in CLVD (longitude); the 0's are ignored in this mode

6. check the output files

> gv $CAPHOME/20080418093700_check/cus_015_fmt_grid.ps &
> diff 20080418093700/cus_015.out $CAPHOME/20080418093700_check/cus_015_fmt_grid.out

====================================================================================
